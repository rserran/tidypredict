run_test <- function(model) {
  tf <- tidypredict_fit(model)
  pm <- parse_model(model)
  test_that("Returns the correct type and dimensions", {
    expect_is(pm, "list")
    expect_equal(length(pm), 2)
    expect_equal(length(pm$trees), 100)
    expect_equal(pm$general$model, "ranger")
    expect_equal(pm$general$version, 2)
  })
  test_that("Returns expected case_when() dplyr formula", {
    expect_equal(
      rlang::expr_text(tf[[1]]),
      "case_when(Petal.Length < 2.45 ~ \"setosa\", Petal.Width < 1.45 & \n    Petal.Width < 1.65 & Petal.Length >= 2.45 ~ \"versicolor\", \n    Sepal.Length < 6.55 & Petal.Width >= 1.65 & Petal.Length >= \n        2.45 ~ \"virginica\", Petal.Length < 4.95 & Petal.Width >= \n        1.45 & Petal.Width < 1.65 & Petal.Length >= 2.45 ~ \"versicolor\", \n    Petal.Width < 1.75 & Sepal.Length >= 6.55 & Petal.Width >= \n        1.65 & Petal.Length >= 2.45 ~ \"versicolor\", Petal.Width >= \n        1.75 & Sepal.Length >= 6.55 & Petal.Width >= 1.65 & Petal.Length >= \n        2.45 ~ \"virginica\", Sepal.Length >= 6.15 & Petal.Length >= \n        4.95 & Petal.Width >= 1.45 & Petal.Width < 1.65 & Petal.Length >= \n        2.45 ~ \"virginica\", Sepal.Width < 2.45 & Sepal.Length < \n        6.15 & Petal.Length >= 4.95 & Petal.Width >= 1.45 & Petal.Width < \n        1.65 & Petal.Length >= 2.45 ~ \"virginica\", Sepal.Width >= \n        2.45 & Sepal.Length < 6.15 & Petal.Length >= 4.95 & Petal.Width >= \n        1.45 & Petal.Width < 1.65 & Petal.Length >= 2.45 ~ \"versicolor\")"
    )
  })
}

context("ranger")
run_test(
  ranger::ranger(Species ~ ., data = iris, num.trees = 100, seed = 100)
)

context("ranger-parsnip")
run_test(
  parsnip::fit(
    parsnip::set_engine(parsnip::rand_forest(trees = 100), "ranger", seed = 100), 
    Species ~ ., data = iris
  )
)
